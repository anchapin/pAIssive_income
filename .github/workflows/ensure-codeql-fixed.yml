name: Ensure Fixed CodeQL Workflows

on:
  pull_request:
    branches: [ main, dev, master, develop ]
    paths:
      - '.github/workflows/codeql*.yml'
      - '.github/scripts/ensure-fixed-codeql-workflows.ps1'
      - '.github/workflows/ensure-codeql-fixed.yml'
  workflow_dispatch:

jobs:
  ensure-fixed-codeql:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure fixed CodeQL workflow files
        shell: pwsh
        run: |
          Write-Host "Ensuring fixed CodeQL workflow files are used..."
          if (Test-Path ".github/scripts/ensure-fixed-codeql-workflows.ps1") {
            Write-Host "Running ensure-fixed-codeql-workflows.ps1 script..."
            ./.github/scripts/ensure-fixed-codeql-workflows.ps1
          } else {
            Write-Host "ensure-fixed-codeql-workflows.ps1 script not found, skipping..."
            exit 1
          }

      - name: Commit changes if needed
        shell: pwsh
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Check if there are changes to commit
          if (git status --porcelain | Select-String ".github/workflows/codeql") {
            Write-Host "Changes detected in CodeQL workflow files. Committing changes..."
            git add .github/workflows/codeql*.yml
            git commit -m "Use fixed CodeQL workflow files [skip ci]"
            
            # Push changes
            git push
            Write-Host "Changes pushed successfully."
          } else {
            Write-Host "No changes to commit. CodeQL workflow files are already up to date."
          }
