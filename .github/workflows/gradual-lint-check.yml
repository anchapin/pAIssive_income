name: Gradual Lint Check

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.py'
      - 'ruff.toml'
      - '.ruff.toml'
      - 'pyproject.toml'
      - '.github/workflows/gradual-lint-check.yml'

permissions:
  contents: write
  pull-requests: write

jobs:
  gradual-lint:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for comparison
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install ruff

    - name: Run critical lint check only
      id: critical_lint
      continue-on-error: true
      run: |
        echo "üîç Running critical lint check on changed files..."
        # Only check for critical errors that could break functionality
        python scripts/gradual_lint_fix.py --mode pr --base-branch main --critical-only

    - name: Auto-fix non-critical issues and commit
      run: |
        echo "üîß Attempting to auto-fix non-critical linting issues..."

        # Configure git for auto-commits
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # Run auto-fix on all changed files
        python scripts/gradual_lint_fix.py --mode pr --base-branch main --fix || echo "Some issues couldn't be auto-fixed"

        # Check if there are any changes to commit
        if ! git diff --quiet; then
          echo "‚úÖ Auto-fixes were applied. Committing changes..."
          git add -A
          git commit -m "fix(lint): auto-fix linting issues in PR #${{ github.event.number }}

          - Applied automatic fixes for import sorting, formatting, and minor issues
          - Focused on maintaining code functionality while improving style
          - Generated by gradual-lint-check workflow"

          # Push the changes back to the PR branch
          git push origin HEAD:${{ github.head_ref }}
          echo "üöÄ Changes pushed to PR branch"
        else
          echo "‚ÑπÔ∏è No auto-fixes were applied"
        fi

    - name: Final critical check
      run: |
        echo "üîç Running final critical check after auto-fixes..."
        if python scripts/gradual_lint_fix.py --mode pr --base-branch main --critical-only; then
          echo "‚úÖ All changed files pass critical linting checks!"
          echo "üí° Non-critical issues may remain but won't block the PR"
        else
          echo "‚ùå Critical linting issues found that need manual attention"
          echo "Please fix the critical errors listed above before merging"
          exit 1
        fi