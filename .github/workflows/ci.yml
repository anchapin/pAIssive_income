name: CI/CD Pipeline

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      lint_only:
        description: 'Run only linting checks'
        required: false
        default: false
        type: boolean
      test_only:
        description: 'Run only tests'
        required: false
        default: false
        type: boolean
      specific_file:
        description: 'Specific file to lint or test'
        required: false
        type: string
      test_path:
        description: 'Path to test directory or file'
        required: false
        default: 'tests/'
        type: string
      skip_docker:
        description: 'Skip Docker build'
        required: false
        default: false
        type: boolean

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: ${{ !github.event.inputs.test_only }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install dependencies
      run: |
        # Clean up any existing .egg-info directories to prevent conflicts
        find . -type d -name "*.egg-info" -exec rm -rf {} + || true
        python -m pip install --upgrade pip
        python -m pip install ruff mypy pyright
        python -m pip install -r requirements-dev.txt
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

    - name: Cache Python packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          .mypy_cache
          .ruff_cache
          .pytest_cache
        key: ${{ runner.os }}-pip-lint-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-lint-

    - name: Create syntax check script
      run: |
        echo "Creating syntax check script..."
        echo '#!/bin/bash
        # Simple script to check Python syntax

        # Check a specific file
        check_file() {
          python -m py_compile "$1" 2>/dev/null
          if [ $? -ne 0 ]; then
            echo "Syntax error in $1"
            return 1
          fi
          return 0
        }

        # Find all Python files excluding common directories to ignore
        find_python_files() {
          find . -name "*.py" -type f -not -path "*/\.*" -not -path "*/venv/*" -not -path "*/.venv/*" -not -path "*/build/*" -not -path "*/dist/*" -not -path "*/__pycache__/*"
        }

        # Main function
        main() {
          if [ $# -gt 0 ]; then
            # Check specific files provided as arguments
            for file in "$@"; do
              check_file "$file" || exit 1
            done
          else
            # Find and check all Python files
            files=$(find_python_files)
            if [ -z "$files" ]; then
              echo "No Python files found"
              exit 0
            fi

            for file in $files; do
              check_file "$file" || exit 1
            done
          fi

          echo "All Python files passed syntax check"
          exit 0
        }

        # Run the main function with all arguments
        main "$@"' > syntax_check.sh
                chmod +x syntax_check.sh

    - name: Check for syntax errors
      run: |
        # Run the syntax check script
        if [ -n "${{ github.event.inputs.specific_file }}" ]; then
          # Validate file path to prevent command injection
          FILE_PATH=$(echo "${{ github.event.inputs.specific_file }}" | tr -d '\n' | sed 's/[^a-zA-Z0-9_\.\/-]//g')
          if [[ "$FILE_PATH" =~ ^[a-zA-Z0-9_\.\/-]+$ ]]; then
            echo "Checking syntax for specific file: $FILE_PATH"
            ./syntax_check.sh "$FILE_PATH"
          else
            echo "Invalid file path provided. Checking all files instead."
            ./syntax_check.sh
          fi
        else
          echo "Checking syntax for all Python files..."
          ./syntax_check.sh
        fi

    - name: Lint with Ruff
      run: |
        if [ -n "${{ github.event.inputs.specific_file }}" ]; then
          # Validate file path to prevent command injection
          FILE_PATH=$(echo "${{ github.event.inputs.specific_file }}" | tr -d '\n' | sed 's/[^a-zA-Z0-9_\.\/-]//g')
          if [[ "$FILE_PATH" =~ ^[a-zA-Z0-9_\.\/-]+$ ]]; then
            echo "Linting specific file with Ruff: $FILE_PATH"
            ruff check "$FILE_PATH"
            ruff format --check "$FILE_PATH"
          else
            echo "Invalid file path provided. Linting all files instead."
            ruff check .
            ruff format --check .
          fi
        else
          echo "Linting all files with Ruff"
          ruff check .
          ruff format --check .
        fi

    - name: Fix formatting issues (if any)
      if: always()
      run: |
        echo "Attempting to fix formatting and syntax issues..."
        if [ -n "${{ github.event.inputs.specific_file }}" ]; then
          # Validate file path to prevent command injection
          FILE_PATH=$(echo "${{ github.event.inputs.specific_file }}" | tr -d '\n' | sed 's/[^a-zA-Z0-9_\.\/-]//g')
          if [[ "$FILE_PATH" =~ ^[a-zA-Z0-9_\.\/-]+$ ]]; then
            echo "Fixing specific file with Ruff: $FILE_PATH"
            ruff check --fix "$FILE_PATH"
            ruff format "$FILE_PATH"
          else
            echo "Invalid file path provided. Fixing all files instead."
            ruff check --fix .
            ruff format .
          fi
        else
          echo "Fixing all files with Ruff"
          ruff check --fix .
          ruff format .
        fi

    - name: Type check with mypy and pyright
      run: |
        if [ -n "${{ github.event.inputs.specific_file }}" ]; then
          # Validate file path to prevent command injection
          FILE_PATH=$(echo "${{ github.event.inputs.specific_file }}" | tr -d '\n' | sed 's/[^a-zA-Z0-9_\.\/-]//g')
          if [[ "$FILE_PATH" =~ ^[a-zA-Z0-9_\.\/-]+$ ]]; then
            echo "Type checking specific file: $FILE_PATH"
            mypy "$FILE_PATH" --ignore-missing-imports --install-types --non-interactive --explicit-package-bases
            pyright "$FILE_PATH"
          else
            echo "Invalid file path provided. Type checking all files instead."
            mypy . --ignore-missing-imports --install-types --non-interactive --explicit-package-bases
            pyright .
          fi
        else
          echo "Type checking all files"
          mypy . --ignore-missing-imports --install-types --non-interactive --explicit-package-bases
          pyright .
        fi

    - name: Check for unused imports
      run: |
        if [ -n "${{ github.event.inputs.specific_file }}" ]; then
          # Validate file path to prevent command injection
          FILE_PATH=$(echo "${{ github.event.inputs.specific_file }}" | tr -d '\n' | sed 's/[^a-zA-Z0-9_\.\/-]//g')
          if [[ "$FILE_PATH" =~ ^[a-zA-Z0-9_\.\/-]+$ ]]; then
            echo "Checking unused imports in specific file: $FILE_PATH"
            ruff check "$FILE_PATH" --select F401
          else
            echo "Invalid file path provided. Checking all files instead."
            ruff check . --select F401
          fi
        else
          echo "Checking unused imports in all files"
          ruff check . --select F401
        fi

  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ !github.event.inputs.lint_only }}
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.12']  # Focusing on Python 3.12 first

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: pip

    - name: Cache Python packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          .pytest_cache
        key: ${{ runner.os }}-pip-test-${{ hashFiles('**/requirements*.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-test-

    - name: Install dependencies
      run: |
        # More aggressive cleanup of egg-info directories
        find . -type d -name "*.egg-info" -exec rm -rf {} + || true
        find . -type d -name "*.dist-info" -exec rm -rf {} + || true
        find . -name "*.egg" -exec rm -f {} + || true

        # Clear pip cache if needed
        pip cache purge || true

        python -m pip install --upgrade pip setuptools wheel
        python -m pip install pytest pytest-cov pytest-xdist pytest-asyncio

        # Install requirements separately (dev first to ensure correct versions)
        if [ -f requirements-dev.txt ]; then
          python -m pip install -r requirements-dev.txt
        fi
        if [ -f requirements.txt ]; then
          python -m pip install -r requirements.txt
        fi

        # Install in development mode with verbose output to debug any issues
        python -m pip install -e . -v

    - name: Create junit directory
      run: mkdir -p junit

    - name: Run tests
      env:
        PYTHONPATH: ${{ github.workspace }}
      run: |
        if [ -n "${{ github.event.inputs.specific_file }}" ]; then
          # Validate file path to prevent command injection
          FILE_PATH=$(echo "${{ github.event.inputs.specific_file }}" | tr -d '\n' | sed 's/[^a-zA-Z0-9_\.\/-]//g')
          if [[ "$FILE_PATH" =~ ^[a-zA-Z0-9_\.\/-]+$ ]]; then
            echo "Testing specific file: $FILE_PATH"
            pytest "$FILE_PATH" \
              -v \
              --import-mode=importlib \
              --cov=. \
              --cov-report=xml \
              --cov-report=term-missing \
              --junitxml=junit/test-results.xml
          else
            echo "Invalid file path provided. Running all tests instead."
            pytest tests \
              -n auto \
              -v \
              --import-mode=importlib \
              --cov=. \
              --cov-report=xml \
              --cov-report=term-missing \
              --cov-fail-under=5 \
              --junitxml=junit/test-results.xml
          fi
        elif [ -n "${{ github.event.inputs.test_path }}" ]; then
          # Validate test path to prevent command injection
          TEST_PATH=$(echo "${{ github.event.inputs.test_path }}" | tr -d '\n' | sed 's/[^a-zA-Z0-9_\.\/-]//g')
          if [[ "$TEST_PATH" =~ ^[a-zA-Z0-9_\.\/-]+$ ]]; then
            echo "Testing path: $TEST_PATH"
            pytest "$TEST_PATH" \
              -n auto \
              --import-mode=importlib \
              --cov=. \
              --cov-report=xml \
              --cov-report=term-missing \
              --junitxml=junit/test-results.xml
          else
            echo "Invalid test path provided. Running all tests instead."
            pytest tests \
              -n auto \
              -v \
              --import-mode=importlib \
              --cov=. \
              --cov-report=xml \
              --cov-report=term-missing \
              --cov-fail-under=5 \
              --junitxml=junit/test-results.xml
          fi
        else
          echo "Running all tests"
          pytest tests \
            -n auto \
            -v \
            --import-mode=importlib \
            --cov=. \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=5 \
            --junitxml=junit/test-results.xml
        fi

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: junit/test-results.xml

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage.xml

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml

  build:
    runs-on: ubuntu-latest
    needs: test
    if: (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev')) || (github.event_name == 'workflow_dispatch' && !inputs.skip_docker)
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Build Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: false
        tags: paissiveincome/app:test
        cache-from: type=local,src=/tmp/.buildx-cache
        cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

    # Temp fix for https://github.com/docker/build-push-action/issues/252
    - name: Move cache
      run: |
        rm -rf /tmp/.buildx-cache
        mv /tmp/.buildx-cache-new /tmp/.buildx-cache
