name: Fix Security Issues

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'common_utils/secrets/**.py'
      - 'fix_potential_secrets.py'

jobs:
  fix-security-issues:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements-dev.txt ]; then
          python -m pip install -r requirements-dev.txt
        fi
        if [ -f requirements.txt ]; then
          python -m pip install -r requirements.txt
        fi

    - name: Fix security issues
      run: |
        echo "Running security issue fixer..."
        python fix_security_issues.py

    - name: Check for changes
      id: git-check
      run: |
        git diff --exit-code || echo "changes=true" >> $GITHUB_OUTPUT

    - name: Commit changes
      if: steps.git-check.outputs.changes == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add .
        git commit -m "Auto-fix security issues"
        git push
