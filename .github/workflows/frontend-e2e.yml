name: Frontend E2E Tests

on:
  pull_request:
    paths:
      - "ui/react_frontend/**"
      - ".github/workflows/frontend-e2e.yml"
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to test on'
        required: false
        default: 'ubuntu'
        type: choice
        options:
          - ubuntu
          - windows
          - both

jobs:
  e2e:
    runs-on: ${{ (github.event.inputs.platform == 'both' || github.event.inputs.platform == '') && 'ubuntu-latest' || format('{0}-latest', github.event.inputs.platform) }}

    defaults:
      run:
        working-directory: ui/react_frontend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up Node.js and pnpm directly in this job
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '8'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      # Install global pnpm if needed (for Windows)
      - name: Install global pnpm (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          $pnpmCmd = Get-Command pnpm -ErrorAction SilentlyContinue
          if (-not $pnpmCmd) {
            Write-Host "Installing pnpm globally with npm..."
            npm install -g pnpm
          }
          pnpm --version

      - name: Install dependencies
        run: pnpm install

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        shell: bash
        run: |
          if [ "$RUNNER_OS" == "Linux" ] || [ "$RUNNER_OS" == "macOS" ]; then
            curl -LsSf https://astral.sh/uv/install.sh | sh
            echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          else
            pip install uv
          fi
        env:
          RUNNER_OS: ${{ runner.os }}

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.uv
            ${{ runner.os == 'Windows' && '%LOCALAPPDATA%\uv' || '' }}
          key: ${{ runner.os }}-uv-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Create virtual environment (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          cd ../..
          # Create virtual environment with uv, fallback to Python's venv module
          echo "Creating virtual environment..."
          uv venv .venv || {
            echo "Failed to create virtual environment with uv. Falling back to Python's venv module..."
            python -m venv .venv || {
              echo "Failed to create virtual environment with Python's venv module. Exiting..."
              exit 1
            }
          }

          # Verify virtual environment was created
          if [ ! -d ".venv" ]; then
            echo "Virtual environment directory .venv not found after creation attempt. Exiting..."
            exit 1
          fi

          echo "Virtual environment created successfully at $(pwd)/.venv"

          # Always ensure pip is installed in the virtual environment
          echo "Ensuring pip is installed in the virtual environment..."
          curl -sSL https://bootstrap.pypa.io/get-pip.py -o get-pip.py
          .venv/bin/python get-pip.py || {
            echo "Failed to bootstrap pip with get-pip.py. Trying alternative method..."
            .venv/bin/python -m ensurepip || {
              echo "Failed to bootstrap pip with ensurepip. Exiting..."
              exit 1
            }
          }

          # Verify pip installation
          if [ ! -f ".venv/bin/pip" ] || ! .venv/bin/python -m pip --version &>/dev/null; then
            echo "pip still not available after installation attempts. Exiting..."
            exit 1
          fi

          echo "pip successfully installed in virtual environment."

          # Upgrade pip first to ensure we have the latest version
          .venv/bin/python -m pip install --upgrade pip || {
            echo "Failed to upgrade pip. Continuing anyway..."
          }

          # Install setuptools and wheel with pip first
          .venv/bin/python -m pip install --upgrade setuptools wheel || {
            echo "Failed to install setuptools and wheel with pip. Continuing anyway..."
          }

          # List installed packages for debugging
          echo "Installed packages in virtual environment:"
          .venv/bin/python -m pip list

          cd ui/react_frontend

      - name: Create virtual environment (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd ../..
          # Create virtual environment with uv, fallback to Python's venv module
          Write-Host "Creating virtual environment..."
          uv venv .venv
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Failed to create virtual environment with uv. Falling back to Python's venv module..."
            python -m venv .venv
            if ($LASTEXITCODE -ne 0) {
              Write-Host "Failed to create virtual environment with Python's venv module. Exiting..."
              exit 1
            }
          }

          # Verify virtual environment was created
          if (-not (Test-Path ".venv")) {
            Write-Host "Virtual environment directory .venv not found after creation attempt. Exiting..."
            exit 1
          }

          Write-Host "Virtual environment created successfully at $(Get-Location)\.venv"

          # Verify python executable exists
          if (-not (Test-Path ".venv\Scripts\python.exe")) {
            Write-Host "Python executable not found in virtual environment. Exiting..."
            exit 1
          }

          # Check if pip module is available
          $pipModuleCheck = .\.venv\Scripts\python.exe -c "import pip; print('pip module exists')" 2>$null
          if (-not $pipModuleCheck -or -not $pipModuleCheck.Contains("pip module exists")) {
            Write-Host "pip module not found in virtual environment. Installing pip..."
            Invoke-WebRequest -Uri https://bootstrap.pypa.io/get-pip.py -OutFile get-pip.py
            .\.venv\Scripts\python.exe get-pip.py
            if ($LASTEXITCODE -ne 0) {
              Write-Host "Failed to bootstrap pip. Exiting..."
              exit 1
            }
          }

          # Verify pip executable exists
          if (-not (Test-Path ".venv\Scripts\pip.exe")) {
            Write-Host "pip executable not found after bootstrap. Creating symlink as last resort..."
            if (Test-Path ".venv\Scripts\python.exe") {
              try {
                New-Item -ItemType SymbolicLink -Path ".venv\Scripts\pip.exe" -Target ".venv\Scripts\python.exe" -ErrorAction SilentlyContinue
              } catch {
                Write-Host "Failed to create symlink. Continuing anyway..."
              }
            }
          }

          # Verify pip is working
          try {
            .\.venv\Scripts\python.exe -m pip --version
            if ($LASTEXITCODE -ne 0) {
              throw "pip command failed"
            }
          } catch {
            Write-Host "pip verification failed. Attempting to reinstall pip..."
            Invoke-WebRequest -Uri https://bootstrap.pypa.io/get-pip.py -OutFile get-pip.py
            .\.venv\Scripts\python.exe get-pip.py
          }

          # List installed packages for debugging
          Write-Host "Installed packages in virtual environment:"
          .\.venv\Scripts\python.exe -m pip list

          cd ui/react_frontend

      - name: Start backend API server (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          cd ../..
          source .venv/bin/activate

          # Always ensure pip is installed and working properly
          echo "Verifying pip installation..."
          if ! python -m pip --version; then
            echo "pip module not available. Installing pip..."
            curl -sSL https://bootstrap.pypa.io/get-pip.py -o get-pip.py
            python get-pip.py || {
              echo "Failed to bootstrap pip with get-pip.py. Trying alternative method..."
              python -m ensurepip || {
                echo "Failed to bootstrap pip with ensurepip. Exiting..."
                exit 1
              }
            }

            # Verify pip installation was successful
            if ! python -m pip --version; then
              echo "pip still not available after installation attempts. Exiting..."
              exit 1
            fi
          fi

          echo "pip is available and working."

          # Upgrade pip first to ensure we have the latest version
          python -m pip install --upgrade pip setuptools wheel || {
            echo "Failed to upgrade pip. Continuing anyway..."
          }

          # Install uv in the virtual environment
          python -m pip install --upgrade uv || {
            echo "Failed to install uv in the virtual environment. Will use system uv..."
          }

          # Install project dependencies with fallback mechanisms
          echo "Installing project dependencies..."
          uv pip install -r requirements.txt || {
            echo "Failed to install requirements.txt with uv pip. Falling back to regular pip..."
            python -m pip install -r requirements.txt
          }

          uv pip install -r requirements-dev.txt || {
            echo "Failed to install requirements-dev.txt with uv pip. Falling back to regular pip..."
            python -m pip install -r requirements-dev.txt
          }

          uv pip install -e . || {
            echo "Failed to install package in development mode with uv pip. Falling back to regular pip..."
            python -m pip install -e .
          }

          # Run the API server with the activated virtual environment
          nohup python ui/api_server.py &
          cd ui/react_frontend
          for i in {1..30}; do
            if curl --silent --fail http://localhost:8000/health; then
              echo "Backend API server is ready."
              break
            fi
            echo "Waiting for backend API server to be ready..."
            sleep 1
          done
          if ! curl --silent --fail http://localhost:8000/health; then
            echo "Backend API server failed to start within 30 seconds."
            exit 1
          fi

      - name: Start backend API server (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd ../..
          .\.venv\Scripts\Activate.ps1

          # Check if pip module is available
          $pipModuleCheck = python -c "import pip; print('pip module exists')" 2>$null
          if (-not $pipModuleCheck -or -not $pipModuleCheck.Contains("pip module exists")) {
            Write-Host "pip module not found in virtual environment. Installing pip..."
            Invoke-WebRequest -Uri https://bootstrap.pypa.io/get-pip.py -OutFile get-pip.py
            .\.venv\Scripts\python.exe get-pip.py
            if ($LASTEXITCODE -ne 0) {
              Write-Host "Failed to bootstrap pip. Exiting..."
              exit 1
            }
          }

          # Verify pip is working
          try {
            python -m pip --version
            if ($LASTEXITCODE -ne 0) {
              throw "pip command failed"
            }
          } catch {
            Write-Host "pip verification failed. Attempting to reinstall pip..."
            Invoke-WebRequest -Uri https://bootstrap.pypa.io/get-pip.py -OutFile get-pip.py
            .\.venv\Scripts\python.exe get-pip.py
          }

          # Upgrade pip first to ensure we have the latest version
          python -m pip install --upgrade pip setuptools wheel
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Failed to upgrade pip. Continuing anyway..."
          }

          # Install uv in the virtual environment
          python -m pip install --upgrade uv
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Failed to install uv in the virtual environment. Will use system uv..."
          }

          # Install project dependencies with fallback mechanisms
          Write-Host "Installing project dependencies..."
          try {
            uv pip install -r requirements.txt
            if ($LASTEXITCODE -ne 0) {
              throw "Failed with uv pip"
            }
          } catch {
            Write-Host "Failed to install requirements.txt with uv pip. Falling back to regular pip..."
            python -m pip install -r requirements.txt
          }

          try {
            uv pip install -r requirements-dev.txt
            if ($LASTEXITCODE -ne 0) {
              throw "Failed with uv pip"
            }
          } catch {
            Write-Host "Failed to install requirements-dev.txt with uv pip. Falling back to regular pip..."
            python -m pip install -r requirements-dev.txt
          }

          try {
            uv pip install -e .
            if ($LASTEXITCODE -ne 0) {
              throw "Failed with uv pip"
            }
          } catch {
            Write-Host "Failed to install package in development mode with uv pip. Falling back to regular pip..."
            python -m pip install -e .
          }

          # Run the API server with the activated virtual environment
          $apiProcess = Start-Process -FilePath ".\.venv\Scripts\python.exe" -ArgumentList "ui/api_server.py" -PassThru -NoNewWindow
          cd ui/react_frontend
          $maxRetries = 30
          $retryCount = 0
          $serverReady = $false

          while (-not $serverReady -and $retryCount -lt $maxRetries) {
            try {
              $response = Invoke-WebRequest -Uri "http://localhost:8000/health" -UseBasicParsing -ErrorAction SilentlyContinue
              if ($response.StatusCode -eq 200) {
                Write-Host "Backend API server is ready."
                $serverReady = $true
              }
            } catch {
              Write-Host "Waiting for backend API server to be ready... (Attempt $($retryCount+1)/$maxRetries)"
              Start-Sleep -Seconds 1
            }
            $retryCount++
          }

          if (-not $serverReady) {
            Write-Error "Backend API server failed to start within 30 seconds."
            exit 1
          }

      - name: Start React development server (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          nohup pnpm start -- --port=3000 &
          # Increase wait time to ensure React app is fully loaded
          sleep 20

          # Check if the server is responding
          echo "Checking if React server is up..."
          curl -s --retry 5 --retry-delay 2 --retry-connrefused http://localhost:3000/ > /dev/null && echo "React server is up!" || echo "Warning: React server may not be fully initialized"

      - name: Start React development server (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Start React server in background
          $reactProcess = Start-Process -FilePath "pnpm" -ArgumentList "start", "--", "--port=3000" -PassThru -NoNewWindow

          # Wait for server to start
          Write-Host "Waiting for React server to start..."
          Start-Sleep -Seconds 20

          # Check if the server is responding
          Write-Host "Checking if React server is up..."
          try {
            $response = Invoke-WebRequest -Uri "http://localhost:3000/" -UseBasicParsing -ErrorAction SilentlyContinue
            if ($response.StatusCode -eq 200) {
              Write-Host "React server is up!"
            } else {
              Write-Host "Warning: React server responded with status code $($response.StatusCode)"
            }
          } catch {
            Write-Host "Warning: React server may not be fully initialized. Error: $_"
          }

      - name: Run Playwright E2E tests (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          # Run tests with retry mechanism
          npx playwright test || npx playwright test --retries=2

      - name: Run Playwright E2E tests (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Run tests with retry mechanism
          npx playwright test
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Tests failed on first attempt. Retrying..."
            npx playwright test --retries=2
          }

      - name: Create and verify playwright-report directory (Linux/macOS)
        if: runner.os != 'Windows' && always()
        shell: bash
        run: |
          mkdir -p playwright-report/
          ls -la playwright-report/ || echo "playwright-report directory is empty or doesn't exist"

      - name: Create and verify playwright-report directory (Windows)
        if: runner.os == 'Windows' && always()
        shell: pwsh
        run: |
          if (-not (Test-Path "playwright-report")) {
            New-Item -ItemType Directory -Path "playwright-report" -Force
          }
          Get-ChildItem -Path "playwright-report" -Force -ErrorAction SilentlyContinue | Format-Table -AutoSize

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ runner.os }}-${{ github.run_id }}
          path: playwright-report/
          if-no-files-found: warn
          retention-days: 30
