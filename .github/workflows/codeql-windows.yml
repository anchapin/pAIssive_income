name: "CodeQL Windows"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '30 1 * * 0'

jobs:
  analyze:
    name: Analyze
    runs-on: windows-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript-typescript', 'python' ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        if: matrix.language == 'javascript-typescript'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        if: matrix.language == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Check disk space
        shell: pwsh
        run: Get-Volume

      # Create a simple package-lock.json if none exists
      - name: Create package-lock.json if needed
        if: matrix.language == 'javascript-typescript'
        shell: pwsh
        run: |
          Write-Host "Checking for lock files before CodeQL analysis..."
          $lockFiles = @(Get-ChildItem -Path . -Recurse -Include "package-lock.json","yarn.lock","pnpm-lock.yaml" -ErrorAction SilentlyContinue)

          if ($lockFiles.Count -gt 0) {
            Write-Host "Found $($lockFiles.Count) lock files:"
            $lockFiles | ForEach-Object {
              Write-Host "  $($_.FullName)"
            }
          } else {
            Write-Host "No lock files found. Creating a minimal package-lock.json..."

            # Create a very simple package-lock.json with minimal content
            $simpleJson = @{
              name = "paissive-income"
              version = "1.0.0"
              lockfileVersion = 3
            }

            try {
              # Method 1: Using ConvertTo-Json
              $jsonContent = ConvertTo-Json -InputObject $simpleJson -Depth 1 -Compress:$false
              Set-Content -Path "package-lock.json" -Value $jsonContent -Encoding UTF8

              if (Test-Path "package-lock.json") {
                $fileInfo = Get-Item "package-lock.json"
                Write-Host "package-lock.json created successfully ($($fileInfo.Length) bytes)"
                Get-Content -Path "package-lock.json"
                Write-Host "Creation method: ConvertTo-Json"
              } else {
                throw "Failed to create package-lock.json using ConvertTo-Json"
              }
            } catch {
              Write-Host "Error creating package-lock.json with ConvertTo-Json: $_"

              # Method 2: Direct string
              try {
                $directJson = '{"name":"paissive-income","version":"1.0.0","lockfileVersion":3}'
                Set-Content -Path "package-lock.json" -Value $directJson -Encoding UTF8

                if (Test-Path "package-lock.json") {
                  $fileInfo = Get-Item "package-lock.json"
                  Write-Host "package-lock.json created successfully ($($fileInfo.Length) bytes)"
                  Get-Content -Path "package-lock.json"
                  Write-Host "Creation method: Direct string"
                } else {
                  throw "Failed to create package-lock.json using direct string"
                }
              } catch {
                Write-Host "Error creating package-lock.json with direct string: $_"

                # Method 3: Ultra simple
                try {
                  Set-Content -Path "package-lock.json" -Value "{}" -Encoding UTF8

                  if (Test-Path "package-lock.json") {
                    $fileInfo = Get-Item "package-lock.json"
                    Write-Host "package-lock.json created with empty object ($($fileInfo.Length) bytes)"
                    Write-Host "Creation method: Empty object"
                  } else {
                    throw "Failed to create package-lock.json with empty object"
                  }
                } catch {
                  Write-Host "CRITICAL ERROR: All methods to create package-lock.json failed: $_"
                }
              }
            }
          }

      # Install dependencies for JavaScript/TypeScript
      - name: Install JS dependencies
        if: matrix.language == 'javascript-typescript'
        shell: pwsh
        run: |
          # Create node_modules directory if it doesn't exist
          if (-not (Test-Path "node_modules")) {
            Write-Host "Creating node_modules directory..."
            New-Item -ItemType Directory -Force -Path "node_modules" | Out-Null
          }

          # Add package-lock.json to .gitignore if it doesn't exist there already
          if (Test-Path ".gitignore") {
            $gitignore = Get-Content -Path ".gitignore" -Raw
            if (-not ($gitignore -match "package-lock\.json")) {
              Write-Host "Adding package-lock.json to .gitignore..."
              Add-Content -Path ".gitignore" -Value "`n# Generated during CodeQL analysis`npackage-lock.json"
            }
          }

      # Install dependencies for Python
      - name: Install Python dependencies
        if: matrix.language == 'python'
        shell: pwsh
        run: |
          python -m pip install --upgrade uv
          uv pip install -r requirements.txt || python -m pip install -r requirements.txt
        continue-on-error: true

      # Display environment information for debugging
      - name: Display environment information
        shell: pwsh
        run: |
          Write-Host "Current directory: $(Get-Location)"
          Write-Host "Directory contents:"
          Get-ChildItem -Path . | Format-Table Name, LastWriteTime, Length

          Write-Host "CodeQL configuration directory:"
          if (Test-Path ".github/codeql") {
            Get-ChildItem -Path ".github/codeql" | Format-Table Name, LastWriteTime, Length
          } else {
            Write-Host "CodeQL configuration directory not found!"
          }

          Write-Host "CodeQL configuration file:"
          if (Test-Path ".github/codeql/security-os-config.yml") {
            Get-Content -Path ".github/codeql/security-os-config.yml" | Select-Object -First 20
            Write-Host "... (truncated)"
          } else {
            Write-Host "CodeQL configuration file not found!"
          }

          Write-Host "JavaScript security queries file:"
          if (Test-Path ".github/codeql/javascript-security-queries.qls") {
            Get-Content -Path ".github/codeql/javascript-security-queries.qls"
          } else {
            Write-Host "JavaScript security queries file not found!"
          }

          Write-Host "Python security queries file:"
          if (Test-Path ".github/codeql/python-security-queries.qls") {
            Get-Content -Path ".github/codeql/python-security-queries.qls"
          } else {
            Write-Host "Python security queries file not found!"
          }

          Write-Host "Checking for package-lock.json:"
          if (Test-Path "package-lock.json") {
            $fileInfo = Get-Item "package-lock.json"
            Write-Host "package-lock.json exists: $($fileInfo.Length) bytes"
            Get-Content -Path "package-lock.json" -First 5
          } else {
            Write-Host "package-lock.json not found!"
          }

      # Initialize CodeQL
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-and-quality
          debug: true

      # Verify CodeQL database creation
      - name: Verify CodeQL database
        shell: pwsh
        run: |
          Write-Host "Checking for CodeQL database..."
          if (Test-Path "$env:RUNNER_TEMP/codeql_databases") {
            Write-Host "CodeQL databases directory exists:"
            Get-ChildItem -Path "$env:RUNNER_TEMP/codeql_databases" -Recurse | Select-Object -First 10 | Format-Table FullName, Length
          } else {
            Write-Host "CodeQL databases directory not found!"
          }

      # Perform CodeQL Analysis
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"
          upload: true
          output: sarif-results/${{ matrix.language }}-windows.sarif

      # Upload SARIF results as an artifact
      - name: Upload SARIF results
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.language }}-windows-sarif
          path: sarif-results/${{ matrix.language }}-windows.sarif
          retention-days: 7