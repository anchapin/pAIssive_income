name: Frontend E2E Tests with Mock API

on:
  pull_request:
    paths:
      - "ui/react_frontend/**"
      - ".github/workflows/frontend-e2e-mock.yml"
  workflow_dispatch:

jobs:
  e2e:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ui/react_frontend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '8'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Install Express for mock API server
        run: pnpm add -D express cors body-parser

      - name: Start mock API server
        shell: bash
        run: |
          node tests/mock_api_server.js &
          echo "Mock API server started"
          # Wait for the server to start
          for i in {1..30}; do
            if curl --silent --fail http://localhost:8000/health; then
              echo "Mock API server is ready."
              break
            fi
            echo "Waiting for mock API server to be ready... (Attempt $i/30)"
            sleep 1
          done
          if ! curl --silent --fail http://localhost:8000/health; then
            echo "Mock API server failed to start within 30 seconds."
            exit 1
          fi

      - name: Start React development server
        shell: bash
        run: |
          # Set environment variable to use the mock API server
          export REACT_APP_API_BASE_URL=http://localhost:8000/api

          # Start React server in background
          nohup pnpm start -- --port=3000 &

          # Wait for server to start with a loop that checks if it's up
          echo "Waiting for React server to start..."
          for i in {1..30}; do
            if curl --silent --fail http://localhost:3000/; then
              echo "React server is ready."
              break
            fi
            echo "Waiting for React server to be ready... (Attempt $i/30)"
            sleep 1
          done

          if ! curl --silent --fail http://localhost:3000/; then
            echo "React server failed to start within 30 seconds."
            exit 1
          fi

      - name: Run Playwright E2E tests
        shell: bash
        run: |
          # Run tests with retry mechanism
          npx playwright test tests/e2e/agent_ui.spec.ts || npx playwright test tests/e2e/agent_ui.spec.ts --retries=2

      - name: Create and verify playwright-report directory
        if: always()
        shell: bash
        run: |
          mkdir -p playwright-report/
          ls -la playwright-report/ || echo "playwright-report directory is empty or doesn't exist"

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ runner.os }}-${{ github.run_id }}
          path: playwright-report/
          if-no-files-found: warn
          retention-days: 30
