name: CodeQL Analysis - Windows
on:
  pull_request:
    branches:
      - main
      - dev
      - master
      - develop
    paths-ignore:
      - '**/*.md'
      - '**/*.txt'
      - '**/*.rst'
      - '**/*.png'
      - '**/*.jpg'
      - '**/*.jpeg'
      - '**/*.gif'
      - '**/*.svg'
      - '**/*.ico'
      - .gitignore
      - docs/**
      - LICENSE
      - SECURITY.md
      - CONTRIBUTING.md
      - CODE_OF_CONDUCT.md
  schedule:
      - cron: 0 4 * * 1
  workflow_dispatch: {}
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
permissions:
  security-events: write
  actions: read
  contents: read
jobs:
  analyze-javascript:
    name: Analyze JavaScript/TypeScript
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
    - name: Shared CI Setup
      run: bash scripts/ci-setup.sh
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Ensure required test directories
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path logs
        New-Item -ItemType Directory -Force -Path coverage
        New-Item -ItemType Directory -Force -Path playwright-report
        New-Item -ItemType Directory -Force -Path test-results
        New-Item -ItemType Directory -Force -Path ci-reports/github
    - name: Cache CodeQL database
      uses: actions/cache@v4
      with:
        path: ~/.codeql/databases
        key: codeql-javascript-${{ github.sha }}
        restore-keys: 'codeql-javascript-

          '
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: '8'
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: pnpm
    - name: Check pnpm version
      run: pnpm --version
    - name: Install dependencies
      shell: pwsh
      run: |
        # Check for package.json in the root directory
        if (Test-Path package.json) {
          Write-Host "Installing dependencies with pnpm in root directory..."
          pnpm install
        } else {
          Write-Host "No package.json found in root directory, checking ui/react_frontend..."
          # Check for package.json in ui/react_frontend
          if (Test-Path ui/react_frontend/package.json) {
            Write-Host "Installing dependencies with pnpm in ui/react_frontend..."
            cd ui/react_frontend
            pnpm install
          } else {
            Write-Host "No package.json found in ui/react_frontend, skipping dependency installation."
          }
        }
      continue-on-error: true
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: javascript-typescript
        queries: security-and-quality
        config-file: ./.github/codeql/security-os-config.yml
    - name: Autobuild
      uses: github/codeql-action/autobuild@v3
    - name: Check disk space
      shell: pwsh
      run: Get-Volume
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        upload: true
        output: sarif-results/javascript-typescript-windows.sarif
    - name: Upload OS-specific CodeQL configuration
      uses: github/codeql-action/upload-sarif@v3
      continue-on-error: true
      with:
        sarif_file: sarif-results/javascript-typescript-windows.sarif
    - name: Upload SARIF results
      uses: actions/upload-artifact@v4
      with:
        name: javascript-typescript-windows-sarif
        path: sarif-results/javascript-typescript-windows.sarif
        retention-days: 7
  analyze-python:
    name: Analyze Python
    runs-on: windows-latest
    timeout-minutes: 60
    steps:
    - name: Shared CI Setup
      run: bash scripts/ci-setup.sh
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Ensure required test directories
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path logs
        New-Item -ItemType Directory -Force -Path coverage
        New-Item -ItemType Directory -Force -Path playwright-report
        New-Item -ItemType Directory -Force -Path test-results
        New-Item -ItemType Directory -Force -Path ci-reports/github
    - name: Cache CodeQL database
      uses: actions/cache@v4
      with:
        path: ~/.codeql/databases
        key: codeql-python-${{ github.sha }}
        restore-keys: 'codeql-python-

          '
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: pip
    - name: Install dependencies
      shell: pwsh
      run: |
        python -m pip install --upgrade uv
        if (Test-Path requirements.txt) {
          Write-Host "Installing pip dependencies from requirements.txt using 'uv pip'..."
          try {
            python -m uv pip install -r requirements.txt
          } catch {
            Write-Host "Failed to install with uv pip, falling back to regular pip..."
            python -m pip install --upgrade pip
            pip install -r requirements.txt
          }
        } elseif (Test-Path requirements-dev.txt) {
          Write-Host "Installing pip dependencies from requirements-dev.txt using 'uv pip'..."
          try {
            python -m uv pip install -r requirements-dev.txt
          } catch {
            Write-Host "Failed to install with uv pip, falling back to regular pip..."
            python -m pip install --upgrade pip
            pip install -r requirements-dev.txt
          }
        } else {
          Write-Host "No requirements.txt or requirements-dev.txt found, skipping dependency installation."
        }
        # Install package in development mode if setup.py exists
        if (Test-Path setup.py) {
          Write-Host "Installing package in development mode using 'uv pip'..."
          try {
            python -m uv pip install -e .
          } catch {
            Write-Host "Failed to install package with uv pip, falling back to regular pip..."
            python -m pip install --upgrade pip
            pip install -e .
          }
        }
      continue-on-error: true
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: python
        queries: security-and-quality
        config-file: ./.github/codeql/security-os-config.yml
    - name: Autobuild
      uses: github/codeql-action/autobuild@v3
    - name: Check disk space
      shell: pwsh
      run: Get-Volume
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        upload: true
        output: sarif-results/python-windows.sarif
    - name: Upload OS-specific CodeQL configuration
      uses: github/codeql-action/upload-sarif@v3
      continue-on-error: true
      with:
        sarif_file: sarif-results/python-windows.sarif
    - name: Upload SARIF results
      uses: actions/upload-artifact@v4
      with:
        name: python-windows-sarif
        path: sarif-results/python-windows.sarif
        retention-days: 7
