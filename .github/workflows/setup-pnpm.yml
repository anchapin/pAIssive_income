name: Setup pnpm

on:
  workflow_dispatch: {}
  schedule:
    - cron: '0 0 * * 0'

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm globally
        run: |
          if ! which pnpm; then
            echo "pnpm not found, installing globally with npm..."
            npm install -g pnpm
          fi

      - name: Verify pnpm installation
        run: |
          pnpm --version
          pnpm config get store-dir
          pnpm config get cache-dir

      - name: Create pnpm directories
        run: |
          mkdir -p .pnpm-store
          mkdir -p .pnpm-cache
          mkdir -p node_modules

      - name: Set up pnpm environment
        run: |
          echo "PNPM_HOME=$HOME/.local/share/pnpm" >> $GITHUB_ENV
          echo "PATH=$PNPM_HOME:$PATH" >> $GITHUB_ENV
          echo "PNPM_STORE_DIR=$GITHUB_WORKSPACE/.pnpm-store" >> $GITHUB_ENV
          echo "PNPM_CACHE_DIR=$GITHUB_WORKSPACE/.pnpm-cache" >> $GITHUB_ENV
